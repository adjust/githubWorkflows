name: Create Preview

on:
  workflow_call:
    inputs:
      ref_name:
        required: false
        type: string
        default: "${{ github.base_ref }}"
    secrets:
      githubToken:
        required: true
jobs:
  # PR is labelled "preview" only if branch name complies with standards
  # contain at most 63 characters
  # contain only lowercase alphanumeric characters or '-'
  # start with an alphanumeric character
  # end with an alphanumeric character
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Validate branch name
        id: validate
        run: |
          if [[ '${{ inputs.ref_name }}' =~ ^[0-9A-Za-z\-]*[^\-]$ ]]; then
            echo "::set-output name=valid::true"
          else
            echo 'Branch name should contain only - and alfa-numerics. Failing to do this will cause issues with k8s namespace and container image creation. Please refer to the documentation - https://kubernetes.io/docs/concepts/overview/working-with-objects/names/'
            echo "::set-output name=valid::false"
          fi

  update_pr:
    needs: validate
    runs-on: ubuntu-latest
    if: steps.validate.outputs.valid == 'true'
    steps:
      - uses: TimonVS/pr-labeler-action@v3
        with:
          configuration-path: .github/pr-labeler.yml
        env:
          GITHUB_TOKEN: ${{ secrets.githubToken }}
      - name: Share preview link in PR comments
        uses: mshick/add-pr-comment@v1
        with:
          message: |
            'Check the deployed **micro-application** k8s preview at [preview](https://dash-${{ github.head_ref }}.qa.cloud.adjust.com/datascape/credentials/)!ðŸš€'
            'Check the deployed **storybook** k8s preview at [storybook](https://dash-${{ github.head_ref }}.qa.cloud.adjust.com/datascape/storybook/)!ðŸš€'
          repo-token: ${{ secrets.githubToken }}
